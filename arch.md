AMBA AXI4 匯流排工具開發架構
===============================

文件版本: 1.0
日期: 2025年7月24日

1.0 總覽 (Overview)
---------------------

1.1 開發目標
本專案的目標是開發一套完整、可靠且高效的 AMBA AXI4 匯流排驗證工具套件（Verification IP, VIP）。此工具套件旨在：
- 模擬 AXI4 組件：提供行為級的 Master、Slave 和 Interconnect 模型。
- 驗證協議一致性：提供監視器 (Monitor) 和檢查器 (Checker)，用於驗證待測設計 (DUT) 是否符合 AXI4 協議規範。
- 加速驗證流程：提供一套可配置、可重用的測試序列庫，用於快速產生各種有效和無效的測試場景。
- 支持複雜系統：架構需具備擴展性，以支持多 Master、多 Slave 的複雜 SoC 驗證環境。

1.2 架構原則
- 模組化 (Modularity)：每個核心組件（Master, Slave, Interconnect, Monitor）應為獨立的、可單獨驗證的單元。
- 可配置性 (Configurability)：所有組件的關鍵參數（如數據位寬、地址位寬、記憶體映射、仲裁策略等）應易於配置，以適應不同的 DUT。
- 可重用性 (Reusability)：採用標準方法學（如 UVM）進行開發，確保組件和測試序列可以在不同專案中被重用。
- 層次化 (Layering)：將測試場景的意圖（Transaction-Level）與信號級的驅動（Signal-Level）分離，提高測試開發效率。


2.0 核心組件架構 (Core Component Architecture)
-----------------------------------------------

工具的核心由四個主要組件構成，每個組件都有明確的職責和可配置的行為。

2.1 AXI Master 組件
- 功能: 主動生成 AXI4 事務，模擬處理器、DMA 控制器等發起端設備。
- 可配置參數:
    - 數據與地址位寬 (C_AXI_DATA_WIDTH, C_AXI_ADDR_WIDTH)。
    - AXI ID 數量與生成邏輯。
    - 支持的突發類型 (INCR, WRAP, FIXED)。
    - 信號生成策略：可配置生成不同的 AxPROT, AxQoS, AxLOCK, AxREGION 值。
    - 時序控制：可配置的地址、數據、響應通道的延遲。
- 內部邏輯:
    1. 序列驅動接口: 提供一個高層次的接口（如 UVM Sequencer），接收來自測試序列的事務級請求 (Transaction)。
    2. 事務轉換器 (Converter): 將事務級請求轉換為詳細的 AXI4 信號級時序。
    3. 地址與數據生成器: 根據請求生成突發地址序列（需正確實現 WRAP 邊界計算）和寫入數據。
    4. 響應處理器: 接收 Slave 的響應 (BRESP, RRESP)，並將其傳回給測試序列進行分析。

2.2 AXI Slave 組件
- 功能: 被動響應 AXI4 事務，模擬記憶體控制器、外設等接收端設備。
- 可配置參數:
    - 數據與地址位寬。
    - 組件類型: 可配置為記憶體 (Memory) 或外設 (Peripheral)。
    - 記憶體映射 (Memory Map): 可配置的地址範圍、讀寫權限、安全與特權屬性。
    - 響應模式: 可配置返回 OKAY, SLVERR 等響應，並支持錯誤注入。
    - 獨占訪問支持: 可開關的獨占訪問監控器 (Exclusive Access Monitor)。
    - 延遲模型: 可配置的讀寫延遲。
- 內部邏輯:
    1. 請求解碼器: 解碼收到的 AXI 地址和控制信號，判斷訪問是否合法（根據記憶體映射中的 AxPROT 權限）。
    2. 後端記憶體模型 (Backend Memory): 實現一個 RAM 模型來存儲數據。對於外設模式，可模擬 FIFO 或寄存器行為。
    3. 獨占訪問監控器: 為每個 ID 記錄獨占讀地址，並在有寫入時清除狀態，以正確處理獨占寫。
    4. 響應生成器: 根據請求的處理結果生成 BRESP 或 RRESP。

2.3 AXI Interconnect 組件
- 功能: 在多個 Master 和多個 Slave 之間路由 AXI4 事務。
- 可配置參數:
    - 上游 Master 端口數量 (N)。
    - 下游 Slave 端口數量 (M)。
    - 地址映射: 可配置的全局地址映射，決定哪個地址範圍路由到哪個 Slave 端口。
    - 仲裁策略: 可配置的仲裁算法（如 Fixed-Priority, Round-Robin, QoS-based）。
    - 協議轉換: 可選支持數據位寬轉換或時鐘域轉換 (CDC) 功能。
- 內部邏輯:
    1. 地址解碼器: 根據地址映射將來自 Master 的請求路由到目標 Slave 端口。若地址未映射，則生成 DECERR 響應。
    2. N-to-M 仲裁器: 根據配置的策略，解決多個 Master 對同一個 Slave 的訪問衝突。
    3. 響應與數據多路器: 將來自不同 Slave 的響應和讀數據正確地路由回對應的 Master。
    4. 事務修改邏輯: 對於 AxCACHE[1]=1 (Modifiable) 的事務，可選擇性地實現合併或拆分等優化。

2.4 AXI 監視器與檢查器 (Monitor and Checker)
- 功能: 被動監聽 AXI 接口，採集信號級活動，重構事務，並檢查協議一致性。
- 監控點: 部署在每個 Master 和 Slave 接口上。
- 內部邏輯:
    1. 信號採集器: 捕獲 AXI 總線上的所有信號變化。
    2. 事務重構器: 將底層的握手信號 (AxVALID/AxREADY) 和數據重構成高層次的事務對象。
    3. 協議檢查器 (Checker):
        - 時序檢查: 驗證握手協議、信號穩定性等基本時序規則。
        - 協議規則檢查: 使用斷言 (Assertion-Based Verification) 檢查關鍵協議規則，例如：
            - 突發不得跨越 4KB 地址邊界。
            - WRAP 突發的長度和地址對齊規則。
            - 相同 ID 事務的排序保證。
            - 獨占訪問的限制條件。


3.0 驗證環境架構 (Verification Environment Architecture)
-------------------------------------------------------

3.1 典型驗證平台拓撲
一個典型的 AXI4 驗證平台應如下圖所示，包含多個核心組件實例，並將其連接到 DUT。

+-------------------------------------------------------------------+
|                           Testbench Top                           |
| +-------------------------+      +------------------------------+ |
| | UVM Test (Sequence Lib) |----->|  Central Configuration Object  | |
| +-------------------------+      +------------------------------+ |
|        |                                                          |
|        v                                                          |
| +-------------------------+                                       |
| |   UVM Environment       |                                       |
| | +---------------------+ |      +------------------------------+ |
| | | AXI Master Agent #1 |<----->|                              | |
| | | (Sequencer, Driver, | |      |                              | |
| | |       Monitor)      |-----\  |                              | |
| | +---------------------+ |    |  |                              | |
| | +---------------------+ |    +->|    AXI Interconnect (DUT)    | |
| | | AXI Master Agent #2 |<----->|                              | |
| | | (Sequencer, Driver, | |    /  |                              | |
| | |       Monitor)      |-----/   |                              | |
| | +---------------------+ |      +------------------------------+ |
| | +---------------------+ |      |          ^          |          | |
| | | AXI Slave Agent #1  |<-------+          |          +-------->| |
| | | (Driver, Monitor)   | |                 |                     | |
| | +---------------------+ |                 |                     | |
| | +---------------------+ |      +----------v----------+ |
| | | AXI Slave Agent #2  |<-------+                     | |
| | | (Driver, Monitor)   | |      | AXI Slave (DUT) #2  | |
| | +---------------------+ |      +---------------------+ |
| |                         |                                       |
| | +---------------------+ |                                       |
| | |  AXI Scoreboard     | |                                       |
| | | (Checks data and    | |                                       |
| | |    ordering)        | |                                       |
| | +---------------------+ |                                       |
| +-------------------------+                                       |
+-------------------------------------------------------------------+

3.2 組件配置與管理
應使用一個中央配置對象 (Central Configuration Object) 來管理整個驗證環境的參數。測試案例在運行開始時配置此對象，然後環境中的所有組件（Master, Slave 等）從中讀取自己的配置信息。這樣可以確保整個測試平台的一致性。

3.3 事務級建模 (Transaction-Level Modeling)
測試序列應在事務級別上進行編寫。開發者只需定義要發送的事務類型（如 axi_read_burst），並設置其屬性（地址、長度、保護類型等），而無需關心底層的信號握手。Master Agent 內的 Driver 負責將這些事務對象轉換為實際的信號驅動。


4.0 測試序列與場景庫架構 (Test Sequence and Scenario Library Architecture)
---------------------------------------------------------------------------

測試序列庫應分層組織，從基礎功能到複雜場景。

4.1 基礎事務序列:
- 單次讀/寫序列。
- 所有突發類型 (INCR, WRAP, FIXED) 的基本功能序列。
- 所有數據寬度和字節選通 (WSTRB) 組合的序列。

4.2 進階功能序列:
- 亂序事務序列: 使用不同 AXI ID 發送多個在途事務，驗證亂序處理能力。
- 順序性保證序列: 使用相同 AXI ID 發送多個事務，驗證其順序性。
- 獨占訪問序列: 模擬旗標的讀-改-寫操作，測試成功和失敗兩種路徑。
- QoS/PROT/REGION 序列: 生成具有各種 AxQoS, AxPROT, AxREGION 組合的事務。

4.3 錯誤注入序列:
- 向 Slave 的可配置地址寫入，觸發 SLVERR。
- 訪問 Interconnect 中未映射的地址，觸發 DECERR。
- Master 生成非法的突發（如跨 4KB 邊界），驗證檢查器的報警。

4.4 壓力與隨機場景:
- 高吞吐量壓力測試：所有 Master 同時以最大帶寬發起請求。
- 完全隨機場景：隨機化所有事務的參數（地址、長度、類型、ID、延時等），以發掘意料之外的 corner case。


5.0 開發與驗證流程建議 (Recommended Development and Verification Flow)
-----------------------------------------------------------------------

1. 單元級驗證:
    - 單獨驗證 Master 組件，將其連接到一個參考 Slave 模型，確保它能生成所有合法的 AXI 事務。
    - 單獨驗證 Slave 組件，使用參考 Master 模型向其發送各種事務，確保其響應正確。
2. 集成級驗證:
    - 將 Master、Slave 和 Interconnect 組件集成在一起，驗證它們之間的協同工作，特別是仲裁和路由邏輯。
3. 系統級驗證:
    - 將您的 AXI 工具套件與實際的 DUT（可能是 AXI Master, Slave 或 Interconnect）集成，運行完整的測試序列庫，進行回歸測試。


附錄 A: 關鍵 AXI4 特性實現檢查表
------------------------------------

+----------------+------------------------------------------------------------------+--------+
| 特性分類       | 檢查項                                                           | 狀態   |
+----------------+------------------------------------------------------------------+--------+
| 核心信號       | AxPROT 的存取控制邏輯是否在 Slave 中實現？                       | [ ]    |
|                | AxQoS 的優先級仲裁是否在 Interconnect 中實現？                   | [ ]    |
|                | Interconnect 是否支持生成可選的 AxREGION 信號？                  | [ ]    |
|                | Interconnect 是否能區分 AxCACHE 的 Modifiable/Non-modifiable 屬性？| [ ]    |
+----------------+------------------------------------------------------------------+--------+
| 功能邏輯       | Slave 是否完整支持獨占訪問的監控與 EXOKAY 響應？                 | [ ]    |
|                | 系統是否能生成並處理所有四種響應 (OKAY, EXOKAY, SLVERR, DECERR)？| [ ]    |
|                | INCR 突發是否支持最高 256 的長度？                               | [ ]    |
|                | WRAP 突發的地址計算邏輯是否正確？                                | [ ]    |
|                | 是否實現了可選的低功耗接口握手？                                 | [ ]    |
+----------------+------------------------------------------------------------------+--------+
| 事務處理       | Interconnect/Slave 是否嚴格遵守基於 AXI ID 的排序規則？            | [ ]    |
|                | 所有組件是否支持可選的 AxUSER 信號直通？                         | [ ]    |
|                | 是否有檢查器來捕捉跨 4KB 邊界的非法突發？                        | [ ]    |
+----------------+------------------------------------------------------------------+--------+
